module AntiImageExploit
  extend ActiveSupport::Concern

  included do
    validate :max_image_size, if: -> { changes["#{anti_image_exploit_name}_file_name"] }

    def max_image_size
      anti_image_exploit_fix if geometry.width.to_i > 10000 || geometry.height.to_i > 10000

    rescue Paperclip::Errors::NotIdentifiedByImageMagickError
      anti_image_exploit_fix
    end
  end

  def geometry
    @geometry ||= Paperclip::Geometry.from_file(
      send(anti_image_exploit_name).queued_for_write[:original] ||
        send(anti_image_exploit_name).path
    )
  end

  def anti_image_exploit_name
    :image
  end

  def anti_image_exploit_fix
    errors[:base] << 'bad image'
    send "#{anti_image_exploit_name}=", nil
  end
end

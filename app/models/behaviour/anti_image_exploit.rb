module AntiImageExploit
  extend ActiveSupport::Concern

  included do
    validate :max_image_size, if: -> { changes["#{send anti_image_exploit}_file_name"] }

    def max_image_size
      errors[:base] << 'bad image' if geometry.width.to_i > 10000 || geometry.height.to_i > 10000
    rescue Paperclip::Errors::NotIdentifiedByImageMagickError
      errors[:base] << 'bad image'
    end
  end

  def geometry
    @geometry ||= Paperclip::Geometry.from_file(
      send(anti_image_exploit).queued_for_write[:original] ||
        send(anti_image_exploit).path
    )
  end

  def anti_image_exploit
    :image
  end
end
